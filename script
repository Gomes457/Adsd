-- UltraFly V6 - Corrigido e com GUI suave, arredondada e draggable
-- Compatível com Xeno / Delta / Hydrogen (executores)
-- Teclas: E = toggle fly, R = toggle noclip, Space/Q vertical, LeftShift turbo, F/G speed

-- ===== SERVICES & REFS
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
if not player then return end
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:FindFirstChildOfClass("Humanoid") or character:WaitForChild("Humanoid")
local hrp = character:FindFirstChild("HumanoidRootPart") or character:WaitForChild("HumanoidRootPart")

-- ===== CONFIG
local BASE_SPEED = 75
local SMOOTH = 0.20
local TURBO_MULT = 2.6
local SPEED_STEP = 5
local GUI_TIME = 3

-- ===== STATE
local flying = false
local bv, bg = nil, nil
local fireMain, fireTrail = nil, nil
local speed = BASE_SPEED
local noclip = false
local originalCanCollide = {}
local boundName = "UltraFlyRenderStep"

-- utility
local function safeDestroy(obj)
    if obj and obj.Parent then
        pcall(function() obj:Destroy() end)
    end
end

local function clamp(n, a, b)
    if n < a then return a end
    if n > b then return b end
    return n
end

-- ===== GUI (cria GUI e retorna função updateHUD)
local function createGUIandHUD()
    -- wait for PlayerGui
    local playerGui = player:WaitForChild("PlayerGui")

    -- cleanup previous guis
    pcall(function()
        local old = playerGui:FindFirstChild("UltraFlyV6_GUI")
        if old then old:Destroy() end
        local oldHud = playerGui:FindFirstChild("UltraFlyV6_HUD")
        if oldHud then oldHud:Destroy() end
    end)

    -- ScreenGui principal
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "UltraFlyV6_GUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui

    -- small startup msg (will auto-destroy)
    local startupGui = Instance.new("ScreenGui")
    startupGui.Name = "UltraFlyV6_Startup"
    startupGui.ResetOnSpawn = false
    startupGui.Parent = playerGui
    local startupFrame = Instance.new("Frame", startupGui)
    startupFrame.Size = UDim2.new(0, 420, 0, 72)
    startupFrame.Position = UDim2.new(0.5, -210, 0.12, 0)
    startupFrame.AnchorPoint = Vector2.new(0.5, 0)
    startupFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
    startupFrame.BorderSizePixel = 0
    local sc = Instance.new("UICorner", startupFrame); sc.CornerRadius = UDim.new(0,12)
    local startupLabel = Instance.new("TextLabel", startupFrame)
    startupLabel.Size = UDim2.new(1, -24, 1, -24)
    startupLabel.Position = UDim2.new(0,12,0,12)
    startupLabel.BackgroundTransparency = 1
    startupLabel.Font = Enum.Font.GothamBold
    startupLabel.TextSize = 20
    startupLabel.TextColor3 = Color3.new(1,1,1)
    startupLabel.Text = "UltraFly V6 — Script Carregado"
    task.delay(GUI_TIME, function()
        pcall(function()
            local tw = TweenService:Create(startupFrame, TweenInfo.new(0.45), {BackgroundTransparency = 1})
            tw:Play()
            task.wait(0.5)
            safeDestroy(startupGui)
        end)
    end)

    -- HUD (top-left small) - drag enabled
    local hudGui = Instance.new("ScreenGui")
    hudGui.Name = "UltraFlyV6_HUD"
    hudGui.ResetOnSpawn = false
    hudGui.Parent = playerGui

    local hudFrame = Instance.new("Frame", hudGui)
    hudFrame.Name = "HUD"
    hudFrame.Size = UDim2.new(0, 220, 0, 88)
    hudFrame.Position = UDim2.new(0.02, 0, 0.02, 0)
    hudFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
    hudFrame.BackgroundTransparency = 0.25
    hudFrame.BorderSizePixel = 0
    local hudCorner = Instance.new("UICorner", hudFrame); hudCorner.CornerRadius = UDim.new(0,12)

    local flyLabel = Instance.new("TextLabel", hudFrame)
    flyLabel.Name = "FlyLabel"
    flyLabel.Size = UDim2.new(1, -12, 0, 28)
    flyLabel.Position = UDim2.new(0,6,0,6)
    flyLabel.BackgroundTransparency = 1
    flyLabel.Font = Enum.Font.Gotham
    flyLabel.TextSize = 16
    flyLabel.TextColor3 = Color3.new(1,1,1)
    flyLabel.Text = "Fly: OFF"

    local noclipLabel = Instance.new("TextLabel", hudFrame)
    noclipLabel.Name = "NoClipLabel"
    noclipLabel.Size = UDim2.new(1, -12, 0, 28)
    noclipLabel.Position = UDim2.new(0,6,0,34)
    noclipLabel.BackgroundTransparency = 1
    noclipLabel.Font = Enum.Font.Gotham
    noclipLabel.TextSize = 14
    noclipLabel.TextColor3 = Color3.new(1,1,1)
    noclipLabel.Text = "NoClip: OFF"

    local speedLabel = Instance.new("TextLabel", hudFrame)
    speedLabel.Name = "SpeedLabel"
    speedLabel.Size = UDim2.new(1, -12, 0, 22)
    speedLabel.Position = UDim2.new(0,6,0,60)
    speedLabel.BackgroundTransparency = 1
    speedLabel.Font = Enum.Font.Gotham
    speedLabel.TextSize = 14
    speedLabel.TextColor3 = Color3.new(1,1,1)
    speedLabel.Text = "Speed: "..tostring(math.floor(speed))

    -- HUD dragging
    do
        local draggingHud = false
        local dragStart = Vector2.new()
        local startPos = hudFrame.Position
        hudFrame.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                draggingHud = true
                dragStart = input.Position
                startPos = hudFrame.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        draggingHud = false
                    end
                end)
            end
        end)
        hudFrame.InputChanged:Connect(function(input)
            if draggingHud and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                hudFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    -- ===== MAIN WINDOW (closed by default)
    local mainFrame = Instance.new("Frame", screenGui)
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 360, 0, 40) -- start closed: small height
    mainFrame.Position = UDim2.new(0.5, -180, 0.4, -200)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(24,24,24)
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    local mainCorner = Instance.new("UICorner", mainFrame); mainCorner.CornerRadius = UDim.new(0,14)

    -- Titlebar inside mainFrame
    local titleBar = Instance.new("Frame", mainFrame)
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.Position = UDim2.new(0,0,0,0)
    titleBar.BackgroundTransparency = 1

    local titleText = Instance.new("TextLabel", titleBar)
    titleText.Size = UDim2.new(0.7, 0, 1, 0)
    titleText.Position = UDim2.new(0.02, 0, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Font = Enum.Font.GothamBold
    titleText.TextSize = 18
    titleText.TextColor3 = Color3.new(1,1,1)
    titleText.Text = "Fly V6"

    -- Open/close button (right)
    local toggleBtn = Instance.new("TextButton", titleBar)
    toggleBtn.Size = UDim2.new(0, 36, 0, 28)
    toggleBtn.Position = UDim2.new(1, -44, 0.5, -14)
    toggleBtn.AnchorPoint = Vector2.new(1, 0.5)
    toggleBtn.Text = "▾"
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextColor3 = Color3.new(1,1,1)
    toggleBtn.BackgroundTransparency = 0
    toggleBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    local toggleCorner = Instance.new("UICorner", toggleBtn); toggleCorner.CornerRadius = UDim.new(0,8)

    -- content area (hidden when closed)
    local content = Instance.new("Frame", mainFrame)
    content.Size = UDim2.new(1, -12, 1, -52)
    content.Position = UDim2.new(0,6,0,46)
    content.BackgroundTransparency = 1
    content.Visible = false

    -- Left controls
    local left = Instance.new("Frame", content)
    left.Size = UDim2.new(0.58, 0, 1, 0)
    left.Position = UDim2.new(0,0,0,0)
    left.BackgroundTransparency = 1

    -- Right player list
    local right = Instance.new("Frame", content)
    right.Size = UDim2.new(0.42, 0, 1, 0)
    right.Position = UDim2.new(0.58, 8, 0, 0)
    right.BackgroundTransparency = 1

    -- Left buttons
    local function makeBtn(txt, y)
        local b = Instance.new("TextButton", left)
        b.Size = UDim2.new(1, 0, 0, 32)
        b.Position = UDim2.new(0, 0, 0, y)
        b.BackgroundColor3 = Color3.fromRGB(55, 130, 255)
        b.Font = Enum.Font.Gotham
        b.TextSize = 14
        b.Text = txt
        b.TextColor3 = Color3.new(1,1,1)
        local bc = Instance.new("UICorner", b); bc.CornerRadius = UDim.new(0,8)
        return b
    end

    local btnFly = makeBtn("Ativar Fly (E)", 0)
    local btnNoClip = makeBtn("Toggle NoClip (R)", 40)
    local btnParticles = makeBtn("Toggle Partículas", 80)
    local btnStopAll = makeBtn("Parar Efeitos (Seleção)", 120)

    -- Right: player list with scrolling
    local plist = Instance.new("ScrollingFrame", right)
    plist.Size = UDim2.new(1, 0, 0.78, 0)
    plist.Position = UDim2.new(0, 0, 0, 0)
    plist.BackgroundTransparency = 0.12
    plist.BorderSizePixel = 0
    local plistCorner = Instance.new("UICorner", plist); plistCorner.CornerRadius = UDim.new(0,8)
    local listLayout = Instance.new("UIListLayout", plist)
    listLayout.Padding = UDim.new(0,6)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder

    local selectedLabel = Instance.new("TextLabel", right)
    selectedLabel.Size = UDim2.new(1, 0, 0, 48)
    selectedLabel.Position = UDim2.new(0, 0, 0.82, 0)
    selectedLabel.BackgroundTransparency = 1
    selectedLabel.Font = Enum.Font.Gotham
    selectedLabel.TextSize = 14
    selectedLabel.TextColor3 = Color3.new(1,1,1)
    selectedLabel.Text = "Nenhum jogador selecionado"

    -- helper to add player button
    local function addPlayerButton(plr)
        if not plr or plr == player then return end
        local btn = Instance.new("TextButton", plist)
        btn.Size = UDim2.new(1, -8, 0, 40)
        btn.BackgroundColor3 = Color3.fromRGB(28,28,28)
        btn.Text = plr.Name
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14
        btn.TextColor3 = Color3.new(1,1,1)
        local corner = Instance.new("UICorner", btn); corner.CornerRadius = UDim.new(0,8)
        local img = Instance.new("ImageLabel", btn)
        img.Size = UDim2.new(0, 36, 0, 36)
        img.Position = UDim2.new(0,6,0.5,-18)
        img.BackgroundTransparency = 1
        pcall(function()
            img.Image = "https://www.roblox.com/headshot-thumbnail/image?userId="..plr.UserId.."&width=420&height=420&format=png"
        end)
        btn.MouseButton1Click:Connect(function()
            _G.SelectedPlayer = plr
            selectedLabel.Text = ("Selecionado: %s (ID: %d)"):format(plr.Name, plr.UserId)
        end)
    end

    -- populate players
    for _,plr in ipairs(Players:GetPlayers()) do
        addPlayerButton(plr)
    end
    Players.PlayerAdded:Connect(function(plr)
        addPlayerButton(plr)
    end)
    Players.PlayerRemoving:Connect(function(plr)
        for _,v in ipairs(plist:GetChildren()) do
            if v:IsA("TextButton") and v.Text == plr.Name then safeDestroy(v) end
        end
        if _G.SelectedPlayer == plr then
            _G.SelectedPlayer = nil
            selectedLabel.Text = "Nenhum jogador selecionado"
        end
    end)

    -- open/close behavior - start closed
    local guiOpen = false
    local closedSize = UDim2.new(0, 360, 0, 40)
    local openSize = UDim2.new(0, 360, 0, 320)

    local function setOpen(open)
        guiOpen = open
        if open then
            -- expand
            content.Visible = true
            toggleBtn.Text = "▴"
            TweenService:Create(mainFrame, TweenInfo.new(0.28, Enum.EasingStyle.Quad), {Size = openSize}):Play()
            TweenService:Create(mainFrame, TweenInfo.new(0.28, Enum.EasingStyle.Quad), {Position = mainFrame.Position}):Play()
        else
            toggleBtn.Text = "▾"
            TweenService:Create(mainFrame, TweenInfo.new(0.28, Enum.EasingStyle.Quad), {Size = closedSize}):Play()
            -- hide content after small delay so tween looks smooth
            task.delay(0.26, function()
                if not guiOpen then
                    content.Visible = false
                end
            end)
        end
    end

    toggleBtn.MouseButton1Click:Connect(function()
        setOpen(not guiOpen)
    end)

    -- T to toggle too
    UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == Enum.KeyCode.T then
            setOpen(not guiOpen)
        end
    end)

    -- draggable mainFrame
    do
        local draggingMain = false
        local dragStart = Vector2.new()
        local startPos = mainFrame.Position
        titleBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                draggingMain = true
                dragStart = input.Position
                startPos = mainFrame.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then draggingMain = false end
                end)
            end
        end)
        titleBar.InputChanged:Connect(function(input)
            if draggingMain and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    -- connect left buttons to update UI / toggle local features (but actual logic updated outside)
    btnFly.MouseButton1Click:Connect(function()
        -- this will be wired: toggle fly externally by changing 'flying' or calling start/stop functions
        -- we only update display here via updateHUD call that will be returned
        flying = not flying
        if flying then
            -- actual startFly will be called externally after createGUI returns
        else
            -- stop
        end
        -- quick immediate visual
        flyLabel.Text = "Fly: "..(flying and "ON" or "OFF")
    end)
    btnNoClip.MouseButton1Click:Connect(function()
        noclip = not noclip
        noclipLabel.Text = "NoClip: "..(noclip and "ON" or "OFF")
    end)
    btnParticles.MouseButton1Click:Connect(function()
        if fireMain then
            fireMain.Enabled = not fireMain.Enabled
        end
    end)
    btnStopAll.MouseButton1Click:Connect(function()
        -- simply attempt to clear some states externally (actual clearing done outside)
        notify("Parar efeitos (implemente lógica no script principal)")
    end)

    -- updateHUD function to be used by main script
    local function updateHUD()
        pcall(function()
            flyLabel.Text = "Fly: "..(flying and "ON" or "OFF")
            noclipLabel.Text = "NoClip: "..(noclip and "ON" or "OFF")
            speedLabel.Text = "Speed: "..tostring(math.floor(speed))
        end)
    end

    -- small notify helper (in GUI scope)
    function notify(text, dur)
        dur = dur or 2
        local f = Instance.new("Frame", screenGui)
        f.Size = UDim2.new(0, 360, 0, 48)
        f.Position = UDim2.new(0.5, -180, 0.12, 0)
        f.AnchorPoint = Vector2.new(0.5,0)
        f.BackgroundColor3 = Color3.fromRGB(16,16,16)
        f.BorderSizePixel = 0
        local c = Instance.new("UICorner", f); c.CornerRadius = UDim.new(0,10)
        local t = Instance.new("TextLabel", f)
        t.Size = UDim2.new(1, -24, 1, -24)
        t.Position = UDim2.new(0,12,0,12)
        t.BackgroundTransparency = 1
        t.Font = Enum.Font.GothamBold
        t.TextSize = 16
        t.TextColor3 = Color3.new(1,1,1)
        t.Text = text
        task.delay(dur, function()
            pcall(function()
                local tw = TweenService:Create(f, TweenInfo.new(0.6), {BackgroundTransparency = 1})
                tw:Play()
                task.wait(0.6)
                safeDestroy(f)
            end)
        end)
    end

    -- return update function and references to GUI parts for external script
    return {
        updateHUD = updateHUD,
        notify = notify,
        mainFrame = mainFrame,
        content = content,
        openToggle = function() setOpen(not guiOpen) end,
        isOpen = function() return guiOpen end,
        screenGui = screenGui,
        hudGui = hudGui,
        selectedPlayerLabel = selectedLabel,
        playerList = plist,
        addPlayerButton = addPlayerButton,
    }
end

-- create GUI and get update function
local guiObjs = createGUIandHUD()
local updateHUD = guiObjs.updateHUD
local notify = guiObjs.notify

-- ===== PARTICLES (local)
local function createFireEffects()
    removeFireEffects()
    if not hrp then return end
    local em = Instance.new("ParticleEmitter")
    em.Name = "UltraFly_FireMain"
    em.Texture = "rbxassetid://241837157"
    em.Rate = 60
    em.Lifetime = NumberRange.new(0.35, 0.6)
    em.Speed = NumberRange.new(6, 14)
    em.SpreadAngle = Vector2.new(40,40)
    em.Size = NumberSequence.new({NumberSequenceKeypoint.new(0,1.2), NumberSequenceKeypoint.new(1,0.3)})
    em.Color = ColorSequence.new(Color3.fromRGB(255,200,60), Color3.fromRGB(255,50,0))
    em.LightEmission = 0.8
    em.Enabled = true
    em.Parent = hrp
    fireMain = em

    local att = Instance.new("Attachment", hrp)
    att.Name = "UltraFlyTrailAtt"
    att.Position = Vector3.new(0, -0.6, 0.9)
    local trail = Instance.new("ParticleEmitter", att)
    trail.Name = "UltraFly_Trail"
    trail.Texture = "rbxassetid://243098098"
    trail.Rate = 80
    trail.Lifetime = NumberRange.new(0.15, 0.4)
    trail.Speed = NumberRange.new(2,6)
    trail.Size = NumberSequence.new({NumberSequenceKeypoint.new(0,1.1), NumberSequenceKeypoint.new(1,0)})
    trail.Color = ColorSequence.new(Color3.fromRGB(255,150,40), Color3.fromRGB(200,40,10))
    trail.LightEmission = 0.6
    trail.Enabled = true
    fireTrail = trail
end

function removeFireEffects()
    safeDestroy(fireMain); safeDestroy(fireTrail)
    if hrp then
        local att = hrp:FindFirstChild("UltraFlyTrailAtt"); safeDestroy(att)
    end
    fireMain, fireTrail = nil, nil
end

-- ===== FLY parts
local function createFlyParts()
    safeDestroy(bv); safeDestroy(bg)
    bv = Instance.new("BodyVelocity")
    bv.Name = "UltraFly_BV"
    bv.MaxForce = Vector3.new(9e9,9e9,9e9)
    bv.P = 1e5
    bv.Velocity = Vector3.new(0,0,0)
    bv.Parent = hrp

    bg = Instance.new("BodyGyro")
    bg.Name = "UltraFly_BG"
    bg.MaxTorque = Vector3.new(9e9,9e9,9e9)
    bg.P = 1e5
    bg.CFrame = hrp.CFrame
    bg.Parent = hrp
end

local function destroyFlyParts()
    safeDestroy(bv); safeDestroy(bg)
    bv, bg = nil, nil
end

-- ===== NOCLIP
local function applyNoClip(enable)
    if not character then return end
    if enable then
        originalCanCollide = {}
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                originalCanCollide[part] = part.CanCollide
                pcall(function() part.CanCollide = false end)
            end
        end
    else
        for part, val in pairs(originalCanCollide) do
            if part and part.Parent then
                pcall(function() part.CanCollide = val end)
            end
        end
        originalCanCollide = {}
    end
end

local noclipConn
local function setNoClipLoop(active)
    if noclipConn then pcall(function() noclipConn:Disconnect() end); noclipConn = nil end
    if active then
        noclipConn = RunService.Stepped:Connect(function()
            if character then
                for _, p in ipairs(character:GetDescendants()) do
                    if p:IsA("BasePart") then
                        pcall(function() p.CanCollide = false end)
                    end
                end
            end
        end)
    end
end

-- ===== START/STOP FLY
local function startFly()
    if flying then return end
    if not character or not hrp or not humanoid then return end
    flying = true
    humanoid.PlatformStand = false
    createFlyParts()
    createFireEffects()
    if fireMain then fireMain.Enabled = true end
    if fireTrail then fireTrail.Enabled = true end

    RunService:BindToRenderStep(boundName, Enum.RenderPriority.Character.Value, function()
        if not flying or not bv or not bg or not hrp then return end

        local fwd = 0
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then fwd = fwd + 1 end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then fwd = fwd - 1 end

        local right = 0
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then right = right + 1 end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then right = right - 1 end

        local vert = 0
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then vert = vert + 1 end
        if UserInputService:IsKeyDown(Enum.KeyCode.Q) then vert = vert - 1 end

        local camCFrame = workspace.CurrentCamera.CFrame
        local forwardVec = Vector3.new(camCFrame.LookVector.X, 0, camCFrame.LookVector.Z)
        local rightVec = Vector3.new(camCFrame.RightVector.X, 0, camCFrame.RightVector.Z)

        local move = (forwardVec.Unit * fwd) + (rightVec.Unit * right)
        if move.Magnitude > 0 then move = move.Unit * speed else move = Vector3.new(0,0,0) end

        -- turbo
        local currentSpeed = speed
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            currentSpeed = currentSpeed * TURBO_MULT
            if fireMain then fireMain.Rate = 120 end
            if fireTrail then fireTrail.Rate = 180 end
        else
            if fireMain then fireMain.Rate = 60 end
            if fireTrail then fireTrail.Rate = 80 end
        end

        move = move + Vector3.new(0, vert * currentSpeed, 0)
        bv.Velocity = bv.Velocity:Lerp(move, clamp(SMOOTH, 0, 1))
        bg.CFrame = CFrame.new(hrp.Position, hrp.Position + camCFrame.LookVector)
    end)
    updateHUD()
end

local function stopFly()
    if not flying then return end
    flying = false
    pcall(function() RunService:UnbindFromRenderStep(boundName) end)
    destroyFlyParts()
    removeFireEffects()
    if hrp then pcall(function() hrp.AssemblyLinearVelocity = Vector3.new() end) end
    updateHUD()
end

-- ===== INPUT HANDLERS
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
    local key = input.KeyCode
    if key == Enum.KeyCode.E then
        if flying then stopFly() else startFly() end
    elseif key == Enum.KeyCode.R then
        noclip = not noclip
        applyNoClip(noclip)
        setNoClipLoop(noclip)
        updateHUD()
    elseif key == Enum.KeyCode.F then
        speed = math.max(10, speed - SPEED_STEP)
        updateHUD()
    elseif key == Enum.KeyCode.G then
        speed = math.min(1000, speed + SPEED_STEP)
        updateHUD()
    end
end)

-- InputEnded (not used but kept)
UserInputService.InputEnded:Connect(function(input, gp)
    -- nothing needed
end)

-- ===== RESPWAN / CLEANUP
local function onCharacterAdded(newChar)
    -- restore/cleanup
    stopFly()
    applyNoClip(false)
    setNoClipLoop(false)
    safeDestroy(fireMain); safeDestroy(fireTrail)
    character = newChar
    humanoid = character:WaitForChild("Humanoid")
    hrp = character:WaitForChild("HumanoidRootPart")
    updateHUD()
end
player.CharacterAdded:Connect(onCharacterAdded)
if humanoid then
    humanoid.Died:Connect(function() stopFly() end)
end

-- initial HUD update
updateHUD()

print("UltraFly V6 corrigido e GUI inicializada (fechada). Use E para fly, T para abrir GUI.")
